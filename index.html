<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CHASE+ ¬∑ lobby button ¬∑ game over</title>

<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
}


    /* ---------- LANDING PAGE (LOBBY) ---------- */
    #landingPage {
      position: fixed;
      inset: 0;
      background: radial-gradient(ellipse at 40% 50%, #1f2d60, #030518);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: opacity 0.4s cubic-bezier(0.2, 0.9, 0.3, 1);
      padding: 16px;
    }

    .landing-card {
      background: rgba(10, 18, 40, 0.7);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border: 2px solid #6dc4ff;
      border-radius: min(8vw, 70px);
      padding: clamp(2rem, 8vw, 3.5rem) clamp(2rem, 10vw, 6rem);
      box-shadow: 0 0 min(10vw, 140px) #3aa8ff, 0 30px 70px #000d1f;
      text-align: center;
      animation: cardFloat 2.2s infinite alternate ease-in-out;
      width: 100%;
      max-width: 800px;
    }

    @keyframes cardFloat {
      0% { transform: translateY(0) scale(1); box-shadow: 0 0 min(8vw, 100px) #3aa8ff; }
      100% { transform: translateY(-12px) scale(1.02); box-shadow: 0 0 min(15vw, 200px) #ffae70, 0 0 min(8vw, 100px) #8069ff; }
    }

    .landing-card h1 {
      font-size: clamp(3.5rem, 15vw, 7rem);
      font-weight: 800;
      letter-spacing: 0.05em;
      background: linear-gradient(135deg, #d2ffb0, #b2ccff, #ffc2a0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 min(6vw, 80px) cyan;
      line-height: 1.1;
      word-break: break-word;
    }

    .landing-card p {
      font-size: clamp(1.4rem, 5vw, 2rem);
      color: #d3e4ff;
      margin: 1rem 0 2rem;
      border-bottom: 2px dashed #88bdff;
      padding-bottom: 1rem;
    }

    /* level selector */
    .level-selector {
      display: flex;
      justify-content: center;
      gap: clamp(0.8rem, 3vw, 2rem);
      margin: 2.5rem 0;
      flex-wrap: wrap;
    }

    .level-btn {
      background: rgba(0, 15, 35, 0.5);
      border: 3px solid #4aa0ff;
      color: white;
      font-size: clamp(1.8rem, 5vw, 2.4rem);
      font-weight: 700;
      padding: clamp(0.8rem, 2vw, 1.2rem) clamp(2rem, 5vw, 3.5rem);
      border-radius: 60px;
      cursor: pointer;
      backdrop-filter: blur(8px);
      box-shadow: 0 0 30px #2a7fff;
      transition: 0.15s;
      text-transform: uppercase;
      min-width: 140px;
    }

    .level-btn.selected {
      background: #4aa0ffcc;
      border-color: #fff7a0;
      box-shadow: 0 0 70px #aaf0ff;
      transform: scale(1.05);
    }

    .level-btn:active {
      transform: scale(0.96);
    }

    .btn-group {
      display: flex;
      gap: clamp(1rem, 4vw, 2.8rem);
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 1rem;
    }

    .neon-btn {
      background: rgba(0, 15, 35, 0.6);
      border: 3px solid #5fd6ff;
      color: white;
      font-size: clamp(1.8rem, 6vw, 2.4rem);
      font-weight: 700;
      padding: clamp(0.8rem, 3vw, 1.2rem) clamp(2rem, 8vw, 4rem);
      border-radius: 60px;
      cursor: pointer;
      backdrop-filter: blur(8px);
      box-shadow: 0 0 min(5vw, 60px) #1eb0ff;
      transition: 0.18s;
      text-transform: uppercase;
      letter-spacing: 1px;
      min-width: 200px;
      flex: 0 1 auto;
    }

    .neon-btn:active {
      background: #5fd6ff66;
      transform: scale(0.96);
    }

    /* ---------- GAME AREA ---------- */
    #gameArea {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: #0c1126;
      cursor: none;
      overflow: hidden;
      box-shadow: inset 0 0 180px #02051a;
      touch-action: none;
    }

    .player, .enemy, .coin {
      position: absolute;
      border-radius: 50%;
      will-change: left, top, filter, transform;
      transition: filter 0.15s, transform 0.1s ease-out;
    }

    .player {
      background: #a8ffb8;
      width: min(8vw, 52px);
      height: min(8vw, 52px);
      min-width: 44px;
      min-height: 44px;
      box-shadow: 0 0 min(6vw, 80px) #aeffae, 0 0 min(4vw, 40px) #6eff9e inset;
      border: 4px solid white;
      z-index: 30;
    }

    .enemy {
      background: #ff3a60;
      width: min(9vw, 58px);
      height: min(9vw, 58px);
      min-width: 48px;
      min-height: 48px;
      box-shadow: 0 0 min(8vw, 100px) #ff657b, 0 0 min(5vw, 50px) #ff0019 inset;
      border: 4px solid #ffb0c3;
      z-index: 20;
    }

    .coin {
      background: radial-gradient(circle at 35% 35%, #fffeb0, #fdbb3a);
      width: min(7vw, 38px);
      height: min(7vw, 38px);
      min-width: 34px;
      min-height: 34px;
      box-shadow: 0 0 min(9vw, 110px) gold, 0 0 min(6vw, 60px) #ffae00;
      border: 3px solid #fffed4;
      z-index: 25;
      transition: transform 0.12s cubic-bezier(0.2, 1.2, 0.8, 1);
    }

    /* floating popup */
    .popup {
      position: fixed;
      color: #fff7b0;
      font-size: clamp(2rem, 8vw, 2.4rem);
      font-weight: 800;
      text-shadow: 0 0 30px gold, 0 0 60px orange;
      pointer-events: none;
      z-index: 999;
      animation: floatUp 1s ease-out forwards;
      white-space: nowrap;
    }

    @keyframes floatUp {
      0% { opacity: 1; transform: translate(0, 0) scale(1); }
      100% { opacity: 0; transform: translate(0, -120px) scale(1.8); }
    }

    /* ---------- TRANSPARENT HUD ---------- */
    #ui {
      position: fixed;
      top: max(12px, env(safe-area-inset-top, 12px));
      left: max(12px, env(safe-area-inset-left, 12px));
      right: max(12px, env(safe-area-inset-right, 12px));
      background: transparent !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      padding: 12px 20px;
      border: none !important;
      color: white;
      font-size: clamp(1.4rem, 5vw, 2rem);
      font-weight: 700;
      box-shadow: none !important;
      z-index: 40;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      pointer-events: none;
      text-shadow: 0 0 15px rgba(255,255,255,0.7);
    }

    #ui > div {
      display: flex;
      align-items: center;
      gap: 8px;
      background: transparent !important;
      padding: 6px 16px;
      border: none !important;
      box-shadow: none !important;
    }

    #speedMeter {
      background: transparent !important;
      border: none !important;
      color: #ffefb0;
    }

    /* level indicator in HUD */
    #levelIndicator {
      position: fixed;
      top: max(12px, env(safe-area-inset-top, 12px));
      left: 50%;
      transform: translateX(-50%);
      background: transparent;
      color: #ffd966;
      font-size: 1.8rem;
      font-weight: 800;
      text-shadow: 0 0 20px cyan, 0 0 40px blue;
      z-index: 41;
      pointer-events: none;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    /* hint */
    #hint {
      position: fixed;
      bottom: max(16px, env(safe-area-inset-bottom, 16px));
      right: max(16px, env(safe-area-inset-right, 16px));
      left: max(16px, env(safe-area-inset-left, 16px));
      background: transparent !important;
      backdrop-filter: none !important;
      padding: 12px 24px;
      border: none !important;
      color: #eaf2ff;
      font-size: clamp(1.4rem, 4vw, 1.7rem);
      font-weight: 600;
      z-index: 45;
      text-align: center;
      width: fit-content;
      margin: 0 auto;
      pointer-events: none;
      white-space: nowrap;
      text-shadow: 0 0 20px cyan, 0 0 8px black;
    }

    /* ---------- GAME OVER with LOBBY button ---------- */
    #gameOver {
      position: fixed;
      inset: 0;
      background: rgba(2, 4, 18, 0.95);
      backdrop-filter: blur(25px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
    }

    .over-card {
      background: #0e163cee;
      padding: clamp(2rem, 8vw, 4rem) clamp(2.5rem, 10vw, 7rem);
      border-radius: min(8vw, 100px);
      border: 5px solid #ffbc7a;
      box-shadow: 0 0 min(15vw, 200px) #ff7b7b, 0 0 min(8vw, 100px) #f6adff;
      text-align: center;
      width: 100%;
      max-width: 800px;
      animation: popIn 0.3s forwards;
    }

    .over-card h1 {
      font-size: clamp(3rem, 12vw, 6rem);
      color: #ffddb5;
      text-shadow: 0 0 min(4vw, 50px) #ff7b00, 0 0 min(8vw, 120px) #ff3838;
      margin-bottom: 1rem;
    }

    .over-card p {
      font-size: clamp(2rem, 7vw, 3rem);
      color: #c1e0ff;
      margin-bottom: 2.5rem;
    }

    .button-row {
      display: flex;
      gap: 1.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .gameover-btn {
      background: transparent;
      border: 4px solid #7df0ff;
      color: white;
      font-size: clamp(1.8rem, 5vw, 2.5rem);
      font-weight: bold;
      padding: clamp(1rem, 3vw, 1.4rem) clamp(2.5rem, 8vw, 4rem);
      border-radius: 80px;
      cursor: pointer;
      box-shadow: 0 0 min(6vw, 80px) #00eeff;
      transition: 0.2s;
      min-width: 180px;
    }

    .gameover-btn.lobby {
      border-color: #ffbc7a;
      box-shadow: 0 0 min(6vw, 80px) #ffae42;
    }

    .gameover-btn:active {
      background: #7df0ff33;
      transform: scale(0.96);
    }

    .gameover-btn.lobby:active {
      background: #ffbc7a33;
    }

    /* landscape adjustments */
    @media (orientation: landscape) and (max-height: 600px) {
      .landing-card { padding: 1.5rem; }
      .landing-card h1 { font-size: clamp(2.5rem, 10vh, 5rem); }
      #ui { padding: 8px 16px; }
      #hint { bottom: 8px; font-size: 1.2rem; padding: 6px 16px; }
    }

    /* ========== NAME MODAL ========== */
    #nameModal {
      position: fixed;
      inset: 0;
      background: rgba(2, 4, 18, 0.96);
      backdrop-filter: blur(30px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 500;
      padding: 20px;
    }

    .name-card {
      background: rgba(10, 18, 50, 0.85);
      border: 3px solid #6dc4ff;
      border-radius: min(8vw, 70px);
      padding: clamp(2.5rem, 8vw, 4rem) clamp(3rem, 10vw, 6rem);
      box-shadow: 0 0 100px #3aa8ff55, 0 30px 70px #000d1f;
      text-align: center;
      width: 100%;
      max-width: 600px;
      animation: popIn 0.3s cubic-bezier(0.2, 1.2, 0.4, 1) forwards;
    }

    @keyframes popIn {
      from { opacity: 0; transform: scale(0.85); }
      to   { opacity: 1; transform: scale(1); }
    }

    .name-card h2 {
      font-size: clamp(2.2rem, 8vw, 3.5rem);
      font-weight: 800;
      background: linear-gradient(135deg, #d2ffb0, #b2ccff, #ffc2a0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.6rem;
    }

    .name-card p {
      color: #9ab8ff;
      font-size: clamp(1.3rem, 4vw, 1.7rem);
      margin-bottom: 2rem;
    }

    #playerNameInput {
      width: 100%;
      background: rgba(0, 15, 50, 0.6);
      border: 3px solid #4aa0ff;
      border-radius: 60px;
      color: white;
      font-size: clamp(1.8rem, 5vw, 2.2rem);
      font-weight: 700;
      padding: 1rem 2rem;
      text-align: center;
      outline: none;
      box-shadow: 0 0 40px #2a7fff44;
      letter-spacing: 1px;
      margin-bottom: 1.8rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    #playerNameInput:focus {
      border-color: #aaf0ff;
      box-shadow: 0 0 60px #1eb0ff88;
    }

    #playerNameInput::placeholder {
      color: #4a6a9f;
    }

    .name-go-btn {
      background: rgba(0, 15, 35, 0.6);
      border: 3px solid #5fd6ff;
      color: white;
      font-size: clamp(1.8rem, 5vw, 2.4rem);
      font-weight: 700;
      padding: clamp(0.8rem, 3vw, 1.2rem) clamp(3rem, 10vw, 5rem);
      border-radius: 60px;
      cursor: pointer;
      box-shadow: 0 0 50px #1eb0ff;
      transition: 0.18s;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .name-go-btn:active {
      background: #5fd6ff44;
      transform: scale(0.96);
    }

    /* ========== LEADERBOARD MODAL ========== */
    #leaderboardModal {
      position: fixed;
      inset: 0;
      background: rgba(2, 4, 18, 0.97);
      backdrop-filter: blur(30px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 400;
      padding: 20px;
    }

    .lb-card {
      background: rgba(10, 18, 50, 0.9);
      border: 3px solid #6dc4ff;
      border-radius: min(8vw, 70px);
      padding: clamp(2rem, 6vw, 3.5rem) clamp(2rem, 8vw, 5rem);
      box-shadow: 0 0 120px #3aa8ff44, 0 30px 80px #000d1f;
      text-align: center;
      width: 100%;
      max-width: 700px;
      animation: popIn 0.3s cubic-bezier(0.2, 1.2, 0.4, 1) forwards;
    }

    .lb-card h2 {
      font-size: clamp(2.5rem, 9vw, 4rem);
      font-weight: 800;
      background: linear-gradient(135deg, #fffdb0, #ffd47a, #ffaa50);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
      letter-spacing: 2px;
    }

    /* tab row */
    .lb-tabs {
      display: flex;
      gap: 0.8rem;
      justify-content: center;
      margin: 1.5rem 0 1.8rem;
      flex-wrap: wrap;
    }

    .lb-tab {
      background: rgba(0,15,35,0.5);
      border: 2px solid #4aa0ff;
      color: #9ab8ff;
      font-size: clamp(1.3rem, 4vw, 1.6rem);
      font-weight: 700;
      padding: 0.6rem 1.8rem;
      border-radius: 40px;
      cursor: pointer;
      transition: 0.15s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .lb-tab.active {
      background: #4aa0ffcc;
      border-color: #fff7a0;
      color: white;
      box-shadow: 0 0 40px #aaf0ff88;
    }

    .lb-tab:active { transform: scale(0.96); }

    /* entries list */
    .lb-list {
      min-height: 220px;
      margin-bottom: 2rem;
    }

    .lb-entry {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.8rem 1.2rem;
      border-radius: 20px;
      margin-bottom: 0.6rem;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(100,180,255,0.15);
      transition: background 0.15s;
    }

    .lb-entry:first-child {
      background: rgba(255,215,0,0.12);
      border-color: rgba(255,215,0,0.4);
    }
    .lb-entry:nth-child(2) {
      background: rgba(192,192,192,0.10);
      border-color: rgba(192,192,192,0.35);
    }
    .lb-entry:nth-child(3) {
      background: rgba(205,127,50,0.10);
      border-color: rgba(205,127,50,0.35);
    }

    .lb-rank {
      font-size: clamp(1.4rem, 4vw, 1.8rem);
      font-weight: 900;
      width: 2.2rem;
      text-align: center;
      flex-shrink: 0;
    }

    .lb-name {
      font-size: clamp(1.4rem, 4vw, 1.8rem);
      font-weight: 700;
      color: #d3e8ff;
      flex: 1;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .lb-score {
      font-size: clamp(1.4rem, 4vw, 1.8rem);
      font-weight: 800;
      color: #fffb90;
      text-shadow: 0 0 16px gold;
      flex-shrink: 0;
    }

    .lb-empty {
      color: #4a6a9f;
      font-size: clamp(1.4rem, 4vw, 1.8rem);
      padding: 3rem 0;
    }

    .lb-close-btn {
      background: transparent;
      border: 3px solid #5fd6ff;
      color: white;
      font-size: clamp(1.6rem, 5vw, 2rem);
      font-weight: 700;
      padding: 0.9rem 3rem;
      border-radius: 60px;
      cursor: pointer;
      box-shadow: 0 0 40px #1eb0ff88;
      transition: 0.18s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .lb-close-btn:active {
      background: #5fd6ff33;
      transform: scale(0.96);
    }

    /* leaderboard button in lobby */
    .neon-btn.lb-open {
      border-color: #ffd47a;
      box-shadow: 0 0 min(5vw, 60px) #ffae42;
    }
</style>
</head>

<body>

<!-- LANDING -->
<div id="landingPage">
  <div class="landing-card">
    <h1>CHASE+</h1>
    <p>‚ö° choose your difficulty ‚ö°</p>

    <div class="level-selector">
      <button class="level-btn selected" id="levelEasy">EASY</button>
      <button class="level-btn" id="levelMedium">MEDIUM</button>
      <button class="level-btn" id="levelHard">HARD</button>
    </div>

    <div class="btn-group">
      <button class="neon-btn" id="startBtn">‚ñ∂ START</button>
      <button class="neon-btn" id="infoBtn">‚ìò INFO</button>
      <button class="neon-btn lb-open" id="lbOpenBtn">üèÜ SCORES</button>
    </div>
  </div>
</div>

<!-- GAME AREA -->
<div id="gameArea" style="display:none;">
  <div class="player" id="player"></div>
  <div class="enemy" id="enemy"></div>
  <div class="coin" id="coin"></div>
</div>

<!-- HUD -->
<div id="ui" style="display:none;">
  <div>üèÜ <span id="score">0</span></div>
  <div>‚ö° <span id="speedValue">1.8</span></div>
</div>

<div id="levelIndicator" style="display:none;">EASY</div>

<!-- GAME OVER -->
<div id="gameOver">
  <div class="over-card">
    <h1>GAME OVER</h1>
    <p>FINAL SCORE: <span id="finalScore">0</span></p>
    <div class="button-row">
      <button class="gameover-btn" id="restartBtn">‚ü≥ RESTART</button>
      <button class="gameover-btn lobby" id="lobbyBtn">üè† LOBBY</button>
    </div>
  </div>
</div>

<!-- üîä GAME OVER SOUND -->
<audio id="gameOverSound" preload="auto">
  <source src="faaah.mp3" type="audio/mpeg">
</audio>

<!-- ===== NAME MODAL ===== -->
<div id="nameModal">
  <div class="name-card">
    <h2>ENTER YOUR NAME</h2>
    <p>Your score will be saved to the leaderboard!</p>
    <input id="playerNameInput" type="text" maxlength="16" placeholder="Player Name" autocomplete="off" spellcheck="false">
    <br>
    <button class="name-go-btn" id="nameGoBtn">üöÄ LET'S GO!</button>
  </div>
</div>

<!-- ===== LEADERBOARD MODAL ===== -->
<div id="leaderboardModal">
  <div class="lb-card">
    <h2>üèÜ LEADERBOARD</h2>
    <div class="lb-tabs">
      <button class="lb-tab active" data-level="EASY">EASY</button>
      <button class="lb-tab" data-level="MEDIUM">MEDIUM</button>
      <button class="lb-tab" data-level="HARD">HARD</button>
    </div>
    <div class="lb-list" id="lbList"></div>
    <button class="lb-close-btn" id="lbCloseBtn">‚úï CLOSE</button>
  </div>
</div>

<script>
(function(){

const landing = document.getElementById('landingPage');
const gameArea = document.getElementById('gameArea');
const ui = document.getElementById('ui');
const gameOver = document.getElementById('gameOver');
const levelIndicator = document.getElementById('levelIndicator');

const playerEl = document.getElementById('player');
const enemyEl = document.getElementById('enemy');
const coinEl = document.getElementById('coin');

const scoreSpan = document.getElementById('score');
const speedSpan = document.getElementById('speedValue');
const finalSpan = document.getElementById('finalScore');

const startBtn = document.getElementById('startBtn');
const restartBtn = document.getElementById('restartBtn');
const lobbyBtn = document.getElementById('lobbyBtn');
const infoBtn = document.getElementById('infoBtn');

const easyBtn = document.getElementById('levelEasy');
const mediumBtn = document.getElementById('levelMedium');
const hardBtn = document.getElementById('levelHard');

const gameOverSound = document.getElementById('gameOverSound');

// Name modal
const nameModal = document.getElementById('nameModal');
const playerNameInput = document.getElementById('playerNameInput');
const nameGoBtn = document.getElementById('nameGoBtn');

// Leaderboard modal
const leaderboardModal = document.getElementById('leaderboardModal');
const lbList = document.getElementById('lbList');
const lbOpenBtn = document.getElementById('lbOpenBtn');
const lbCloseBtn = document.getElementById('lbCloseBtn');
const lbTabs = document.querySelectorAll('.lb-tab');

let player = {x:300,y:300};
let enemy = {x:600,y:400};
let coin = {x:200,y:200};

let enemySpeed = 1.2;
let score = 0;
let gameActive = false;
let animFrame = null;
let currentLevel = "EASY";
let playerName = "";
let currentLbLevel = "EASY";

/* ---------- LEVEL CONFIG ---------- */
const levelConfig = {
  EASY:   { base:1.2, inc:0.10 },
  MEDIUM: { base:2.0, inc:0.15 },
  HARD:   { base:3.0, inc:0.20 }
};

/* ---------- LEADERBOARD STORAGE ---------- */
const STORAGE_KEY = "chaseplus_lb";

function loadLeaderboard() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : { EASY:[], MEDIUM:[], HARD:[] };
  } catch(e) {
    return { EASY:[], MEDIUM:[], HARD:[] };
  }
}

function saveScore(name, scoreVal, level) {
  const lb = loadLeaderboard();
  lb[level].push({ name: name.trim() || "Anonymous", score: scoreVal });
  lb[level].sort((a,b) => b.score - a.score);
  lb[level] = lb[level].slice(0, 5); // keep top 5
  localStorage.setItem(STORAGE_KEY, JSON.stringify(lb));
}

function renderLeaderboard(level) {
  const lb = loadLeaderboard();
  const entries = lb[level] || [];
  const medals = ["ü•á","ü•à","ü•â","4Ô∏è‚É£","5Ô∏è‚É£"];

  if (entries.length === 0) {
    lbList.innerHTML = '<div class="lb-empty">No scores yet!<br>Be the first to play!</div>';
    return;
  }

  lbList.innerHTML = entries.map((e, i) => `
    <div class="lb-entry">
      <span class="lb-rank">${medals[i] || (i+1)}</span>
      <span class="lb-name">${escapeHtml(e.name)}</span>
      <span class="lb-score">üèÜ ${e.score}</span>
    </div>
  `).join('');
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ---------- LEADERBOARD UI ---------- */
lbTabs.forEach(tab => {
  tab.onclick = () => {
    lbTabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentLbLevel = tab.dataset.level;
    renderLeaderboard(currentLbLevel);
  };
});

lbOpenBtn.onclick = () => {
  currentLbLevel = currentLevel;
  lbTabs.forEach(t => {
    t.classList.toggle('active', t.dataset.level === currentLbLevel);
  });
  renderLeaderboard(currentLbLevel);
  leaderboardModal.style.display = 'flex';
};

lbCloseBtn.onclick = () => {
  leaderboardModal.style.display = 'none';
};

/* ---------- LEVEL SELECTION ---------- */
function setLevel(level){
  currentLevel = level;

  easyBtn.classList.remove("selected");
  mediumBtn.classList.remove("selected");
  hardBtn.classList.remove("selected");

  if(level==="EASY") easyBtn.classList.add("selected");
  if(level==="MEDIUM") mediumBtn.classList.add("selected");
  if(level==="HARD") hardBtn.classList.add("selected");

  levelIndicator.innerText = level;
}

easyBtn.onclick   = ()=> setLevel("EASY");
mediumBtn.onclick = ()=> setLevel("MEDIUM");
hardBtn.onclick   = ()=> setLevel("HARD");

/* ---------- HELPERS ---------- */
function randPos(size=50){
  return{
    x:Math.random()*(window.innerWidth-size),
    y:Math.random()*(window.innerHeight-size)
  };
}

function randomizeAll(){
  player=randPos(50);
  enemy=randPos(55);
  coin=randPos(35);
}

function updateDOM(){
  playerEl.style.left=player.x+"px";
  playerEl.style.top=player.y+"px";
  enemyEl.style.left=enemy.x+"px";
  enemyEl.style.top=enemy.y+"px";
  coinEl.style.left=coin.x+"px";
  coinEl.style.top=coin.y+"px";
}

function handleMove(x,y){
  if(!gameActive) return;
  player.x=x-25;
  player.y=y-25;
}

window.addEventListener("mousemove",e=>{
  handleMove(e.clientX,e.clientY);
});

window.addEventListener("touchmove",e=>{
  const t=e.touches[0];
  handleMove(t.clientX,t.clientY);
},{passive:false});

/* ---------- GAME LOGIC ---------- */
function moveEnemy(){
  const dx=player.x-enemy.x;
  const dy=player.y-enemy.y;
  const dist=Math.hypot(dx,dy);
  if(dist>1){
    enemy.x+=dx/dist*enemySpeed;
    enemy.y+=dy/dist*enemySpeed;
  }
}

function collides(a,b){
  return Math.hypot(a.x-b.x,a.y-b.y)<40;
}

function checkCollisions(){
  if(collides(player,enemy)){
    gameActive=false;

    gameOverSound.currentTime=0;
    gameOverSound.play();

    // Save score to leaderboard
    saveScore(playerName, score, currentLevel);

    finalSpan.innerText=score;
    gameOver.style.display="flex";
    if(navigator.vibrate) navigator.vibrate(120);
    return;
  }

  if(collides(player,coin)){
    score++;
    enemySpeed+=levelConfig[currentLevel].inc;

    scoreSpan.innerText=score;
    speedSpan.innerText=enemySpeed.toFixed(2);
    coin=randPos(35);
  }
}

function gameLoop(){
  if(!gameActive) return;
  moveEnemy();
  checkCollisions();
  updateDOM();
  animFrame=requestAnimationFrame(gameLoop);
}

/* ---------- NAME MODAL ---------- */
function showNameModal(callback) {
  playerNameInput.value = playerName || "";
  nameModal.style.display = "flex";
  setTimeout(()=> playerNameInput.focus(), 100);

  const go = () => {
    const name = playerNameInput.value.trim();
    if (!name) {
      playerNameInput.style.borderColor = "#ff6060";
      playerNameInput.style.boxShadow = "0 0 40px #ff303088";
      setTimeout(()=>{
        playerNameInput.style.borderColor = "";
        playerNameInput.style.boxShadow = "";
      }, 600);
      return;
    }
    playerName = name;
    nameModal.style.display = "none";
    nameGoBtn.onclick = null;
    playerNameInput.onkeydown = null;
    callback();
  };

  nameGoBtn.onclick = go;
  playerNameInput.onkeydown = (e) => { if(e.key === "Enter") go(); };
}

/* ---------- START / RESTART ---------- */
function startGame(){
  landing.style.display="none";
  gameArea.style.display="block";
  ui.style.display="flex";
  levelIndicator.style.display="block";
  gameOver.style.display="none";

  score=0;
  enemySpeed=levelConfig[currentLevel].base;

  scoreSpan.innerText="0";
  speedSpan.innerText=enemySpeed.toFixed(2);

  randomizeAll();
  gameActive=true;
  gameLoop();
}

startBtn.onclick = () => {
  showNameModal(() => startGame());
};

function restartGame(){
  gameOver.style.display="none";
  score=0;
  enemySpeed=levelConfig[currentLevel].base;

  scoreSpan.innerText="0";
  speedSpan.innerText=enemySpeed.toFixed(2);

  randomizeAll();
  gameActive=true;
  gameLoop();
}

function goToLobby(){
  gameActive=false;
  gameArea.style.display="none";
  ui.style.display="none";
  levelIndicator.style.display="none";
  gameOver.style.display="none";
  landing.style.display="flex";
}

/* ---------- BUTTONS ---------- */
restartBtn.onclick=restartGame;
lobbyBtn.onclick=goToLobby;

infoBtn.onclick=()=>{
  alert(
`EASY   : 1.2 speed
MEDIUM : 2.0 speed
HARD   : 3.0 speed`
  );
};

setLevel("EASY");
randomizeAll();

})();
</script>

</body>
</html>